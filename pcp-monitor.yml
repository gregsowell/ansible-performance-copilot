---
- name: Install/configure PCP monitor host
  hosts: pcp-monitor
  gather_facts: false
  vars:
    # Services to be enabled/started
    enable_services: 
#      - pmcd
      - pmlogger
    
    collection_directory: /var/log/pcp/pmlogger/
#     # The subnets or ranges of hosts allowed to connect to clients to fetch info
#     remote_subnets:
#       - 10.0.*
#       - 192.168.5.10
# #      - 1.1.1.1

  tasks:
  - name: debug data
    ansible.builtin.debug:
      var: hostvars[item]
    loop: "{{ groups['pcp-hosts'] }}"

  - name: Install pcp packages
    ansible.builtin.dnf:
      name: "{{ item }}"
      state: latest
    loop:
      - pcp
      - pcp-system-tools
    notify: restart pcp

  - name: Create config file for each pcp-host
    ansible.builtin.template:
      src: pmlogger-monitor.j2
      dest: "/etc/pcp/pmlogger/control.d/{{ inventory_hostname }}"
    loop: "{{ groups['pcp-hosts'] }}"
    notify: restart pcp
    
  - name: Create collector host directories by looping over pcp-hosts group
    ansible.builtin.file:
      path: "{{ collection_directory }}{{ item }}"
      state: directory
      mode: '0755'
    loop: "{{ groups['pcp-hosts'] }}"

  - name: Start and enable pcp services
    ansible.builtin.service:
      name: "{{ item }}"
      state: started
      enabled: true
    loop: "{{ enable_services }}"

  handlers:
  - name: restart pcp
    ansible.builtin.service:
      name: "{{ item }}"
      state: restarted
    loop: "{{ enable_services }}"
